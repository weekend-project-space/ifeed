# AI 优先 RSS 阅读器：接口文档 (API 文档)

本接口文档描述了前端与后端交互所使用的 RESTful API。

> **分页说明**
> 所有带有 `page` / `size` 查询参数的接口均返回 Spring Data `Page` 风格的响应，示例结构如下（页码从 0 开始）：
>
> ```json
> {
>   "content": [ ... ],
>   "pageable": {
>     "pageNumber": 0,
>     "pageSize": 10,
>     "sort": {
>       "sorted": false,
>       "unsorted": true,
>       "empty": true
>     }
>   },
>   "totalElements": 42,
>   "totalPages": 5,
>   "last": false,
>   "first": true,
>   "size": 10,
>   "number": 0,
>   "sort": {
>     "sorted": false,
>     "unsorted": true,
>     "empty": true
>   },
>   "numberOfElements": 10,
>   "empty": false
> }
> ```

## 1. 用户认证

### 注册

- 方法：`POST /api/auth/register`
- 认证：无需认证
- 请求体：

```json
{
  "username": "string",
  "password": "string"
}
```

- 响应体：

```json
{
  "token": "string",
  "userId": "string"
}
```

### 登录

- 方法：`POST /api/auth/login`
- 认证：无需认证
- 请求体：

```json
{
  "username": "string",
  "password": "string"
}
```

- 响应体：

```json
{
  "token": "string",
  "userId": "string"
}
```

### 登出

- 方法：`POST /api/auth/logout`
- 认证：`Bearer <token>`（可选）
- 请求体：无
- 响应体：无内容（204 No Content）
- 说明：登出当前用户会话，使 token 失效。如果提供了有效的 Authorization 头，服务器会将该 token 标记为失效。

### 获取用户信息

- 方法：`GET /api/user`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "userId": "string",
  "username": "string"
}
```

## 2. 订阅管理

### 添加订阅

- 方法：`POST /api/subscriptions`
- 认证：`Bearer <token>`
- 请求体：

```json
{
  "feedUrl": "string (可选)",
  "sourceId": "string (可选, UUID)"
}
```

- 说明：
  - `feedUrl` 和 `sourceId` 至少提供其一
  - 当提供 `sourceId` 时，**自动检测**订阅类型：
    - 先尝试按 Feed UUID 查找，如果找到则订阅该 Feed
    - 如果未找到 Feed，尝试按 MixFeed UUID 查找，如果找到则订阅该 MixFeed
    - 如果都未找到，返回 404 错误
  - 当提供 `feedUrl` 时，创建或查找对应的 Feed 并订阅
- 响应体：

```json
{
  "message": "Subscription added."
}
```

### 获取订阅列表

- 方法：`GET /api/subscriptions`
- 认证：`Bearer <token>`
- 响应体：

```json
[
  {
    "feedId": "string",
    "title": "string",
    "url": "string",
    "siteUrl": "string",
    "avatar": "https://example.com",
    "lastFetched": "2024-03-01T08:00:00Z",
    "lastUpdated": "2024-03-01T09:45:00Z",
    "isRead": true,
    "failureCount": 0,
    "fetchError": null,
    "type": "FEED",
    "icon": "https://example.com/favicon.ico"
  }
]
```

- 说明：
  - 返回所有订阅（包括 Feed 和 MixFeed）
  - `type` 字段标识订阅类型：`FEED` 或 `MIX_FEED`
  - Feed 相关字段：
    - `lastFetched`：后端最近一次抓取该源的时间
    - `siteUrl`：订阅源对应的网站主页，当缺失时回退至 `url`
    - `lastUpdated`：RSS 源内容检测到的最近更新时间，用于前端提示源的活跃度
    - `isRead`：当前用户已读
    - `failureCount`：连续抓取失败次数，成功抓取后会归零
    - `fetchError`：最近一次抓取失败的错误提示，若暂无失败则为 `null`



### 取消订阅

- 方法：`DELETE /api/subscriptions/:feedId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Subscription removed."
}
```

### 上传并解析 OPML

- 方法：`POST /api/subscriptions/opml/preview`
- 认证：`Bearer <token>`
- 描述：上传 OPML 文件并解析出订阅源列表，返回结果供用户确认。
- 请求体：`multipart/form-data`
  - `file`：OPML 文件，建议 `Content-Type` 为 `text/x-opml` 或 `application/xml`
- 响应体：

```json
{
  "feeds": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "title": "string",
      "siteUrl": "https://example.com",
      "avatar": "https://example.com/icon.png",
      "alreadySubscribed": false,
      "errors": []
    }
  ],
  "warnings": ["string"],
  "remainingQuota": 480
}
```

- `remainingQuota`：可用订阅额度。每个账号默认上限 500 个订阅，该字段为 `500 - 已订阅数量`。

- 响应码：
  - `200 OK`
  - `400 Bad Request`（文件缺失、格式不合法或无有效订阅）
  - `413 Payload Too Large`
  - `415 Unsupported Media Type`

### 确认 OPML 导入

- 方法：`POST /api/subscriptions/opml/confirm`
- 认证：`Bearer <token>`
- 描述：接收预览结果中的订阅源列表并执行导入，仅导入 `selected = true` 的条目。
- 请求体：

```json
{
  "feeds": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "title": "string",
      "siteUrl": "https://example.com",
      "avatar": "https://example.com/icon.png",
      "selected": true
    }
  ]
}
```

- 响应体：

```json
{
  "importedCount": 3,
  "skipped": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "reason": "ALREADY_SUBSCRIBED"
    }
  ],
  "message": "OPML import completed."
}
```

- 响应码：
  - `200 OK`
  - `400 Bad Request`（请求体为空或结构不符）
  - `409 Conflict`（部分条目导入失败，详情见 `skipped`）
  - `422 Unprocessable Entity`（字段缺失或内容非法）

## 3. MixFeed 管理

MixFeed 是一种虚拟聚合源，允许用户从多个订阅源中筛选和组合文章。

### 创建 MixFeed

- 方法：`POST /api/mix-feeds`
- 认证：`Bearer <token>`
- 请求体：

```json
{
  "name": "string",
  "description": "string (可选)",
  "icon": "string (可选)",
  "isPublic": false,
  "filterConfig": {
    "sourceFeeds": {
      "uuid1": "Feed Name 1",
      "uuid2": "Feed Name 2"
    },
    "keywords": {
      "include": ["AI", "技术"],
      "exclude": ["广告"]
    },
    "dateRange": {
      "from": "2024-01-01T00:00:00Z",
      "to": "2024-12-31T23:59:59Z"
    },
    "sortBy": "publishedAt",
    "sortOrder": "DESC"
  }
}
```

- 响应体：

```json
{
  "message": "MixFeed created."
}
```

- 说明：
  - `filterConfig` 为可选字段，各子字段也均为可选
  - `sourceFeeds` 为空表示包含所有订阅源
  - `isPublic` 为 true 时，该 MixFeed 会在公开市场显示

### 获取我的 MixFeed 列表

- 方法：`GET /api/mix-feeds`
- 认证：`Bearer <token>`
- 响应体：

```json
[
  {
    "mixFeedId": "string (UUID)",
    "name": "string",
    "description": "string",
    "icon": "string",
    "subscriberCount": 0,
    "isPublic": false,
    "createdAt": "2024-03-01T10:00:00Z"
  }
]
```

### 获取 MixFeed 详情

- 方法：`GET /api/mix-feeds/{id}`
- 认证：`Bearer <token>`
- 路径参数：
  - `id`: MixFeed UUID
- 响应体：

```json
{
  "mixFeedId": "string (UUID)",
  "name": "string",
  "description": "string",
  "icon": "string",
  "subscriberCount": 123,
  "articleCount": 456,
  "subscribed": true,
  "isPublic": false,
  "createdAt": "2024-03-01T10:00:00Z",
  "updatedAt": "2024-03-02T15:30:00Z"
}
```

- 说明：
  - 只能访问公开的 MixFeed 或自己创建的 MixFeed
  - `subscribed` 表示当前用户是否已订阅该 MixFeed

### 更新 MixFeed

- 方法：`PUT /api/mix-feeds/{id}`
- 认证：`Bearer <token>`
- 路径参数：
  - `id`: MixFeed UUID
- 请求体：（所有字段均可选）

```json
{
  "name": "string",
  "description": "string",
  "icon": "string",
  "isPublic": true,
  "filterConfig": {
    "sourceFeeds": {
      "uuid1": "Feed Name 1",
      "uuid2": "Feed Name 2"
    }
  }
}
```

- 响应体：

```json
{
  "message": "MixFeed updated."
}
```

- 说明：
  - 只能更新自己创建的 MixFeed

### 删除 MixFeed

- 方法：`DELETE /api/mix-feeds/{id}`
- 认证：`Bearer <token>`
- 路径参数：
  - `id`: MixFeed UUID
- 响应体：

```json
{
  "message": "MixFeed deleted."
}
```

- 说明：
  - 只能删除自己创建的 MixFeed
  - 如存在活跃订阅者，删除将失败（返回 400）

### 浏览公开 MixFeed

- 方法：`GET /api/mix-feeds/public`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（默认 `subscriberCount,desc`）
- 响应体：分页格式

```json
{
  "content": [
    {
      "mixFeedId": "string (UUID)",
      "name": "string",
      "description": "string",
      "icon": "string",
      "subscriberCount": 123,
      "isPublic": true,
      "createdAt": "2024-03-01T10:00:00Z"
    }
  ],
  "totalElements": 42,
  "totalPages": 5
}
```

## 4. 文章内容

### 获取文章列表

- 方法：`GET /api/articles`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（可选，如 `publishedAt,desc`）
  - `feedId`（可选，Feed 或 MixFeed 的 UUID）
  - `tags`（可选，按标签过滤，多个用逗号分隔）
  - `category`（可选，按文章分类过滤，大小写不敏感）
  - `source`（可选，默认 `owner`。`owner`：只返回当前用户的数据；`global`：返回全局数据，不区分用户）
- 说明：
  - 当不指定 `feedId` 时，返回所有订阅源的文章
  - 当指定 `feedId` 时，**自动检测**是 Feed 还是 MixFeed：
    - 先尝试按 Feed UUID 查询，如果找到则返回该 Feed 的文章
    - 如果未找到 Feed，再尝试按 MixFeed UUID 查询，如果找到则返回该 MixFeed 的文章（基于过滤规则）
    - 如果都未找到，返回 404 错误
  - MixFeed 的文章基于当前用户订阅的 Feed，应用 MixFeed 的过滤规则
- 响应体：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "link": "string",
      "summary": "string",
      "thumbnail": "https://example.com/cover.jpg",
      "enclosure": "https://example.com/audio.mp3",
      "feedTitle": "string",
      "publishedAt": "2024-03-01T10:00:00Z",
      "tags": ["AI", "推荐"],
      "timeAgo": "2 小时前"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 42,
  "totalPages": 5,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

- `thumbnail`：用于展示文章缩略图，通常来自 RSS 中的图片资源，可能为空。
- `enclosure`：原始多媒体资源链接（音频、视频等），可用于播放器或下载。
- `tags` 查询支持逗号分隔的多个标签，忽略大小写。
- `category` 查询按文章 `category` 字段精确匹配（忽略大小写）。

### 获取文章详情

- 方法：`GET /api/articles/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "id": "string",
  "title": "string",
  "content": "string",
  "summary": "string",
  "thumbnail": "https://example.com/cover.jpg",
  "enclosure": "https://example.com/audio.mp3",
  "feedId": "string",
  "feedTitle": "string",
  "publishedAt": "2024-03-01T10:00:00Z",
  "tags": ["AI", "推荐"],
  "collected": true
}
```

- `collected`：当前用户是否已收藏该文章。

### 获取推荐文章

- 方法：`GET /api/articles/recommendations`
- 认证：`Bearer <token>`
- 查询参数：
  - `size`（可选，默认 10，最大 30）
  - `page`（默认 0）
- 响应体示例：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "link": "string",
      "summary": "string",
      "thumbnail": "https://example.com/cover.jpg",
      "enclosure": "https://example.com/audio.mp3",
      "feedTitle": "string",
      "publishedAt": "2024-03-01T10:00:00Z",
      "timeAgo": "2 小时前"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 42,
  "totalPages": 5,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 获取订阅内容概览（分类与热门标签）

- 方法：`GET /api/articles/insights`
- 认证：`Bearer <token>`
- 查询参数：
  - `from`（可选，ISO-8601 时间，默认 `now-30d`）
  - `to`（可选，ISO-8601 时间，默认 `now`）
  - `top`（可选，热门标签返回个数，默认 20）
- 说明：统计当前用户可见范围内（其激活的订阅源）的文章，在给定时间窗口内的分类计数和热门标签。
- 响应体：

```json
{
  "categories": [
    {
      "category": "Tech",
      "count": 12
    },
    {
      "category": "AI",
      "count": 8
    }
  ],
  "hotTags": [
    {
      "tag": "llm",
      "count": 10
    },
    {
      "tag": "java",
      "count": 7
    }
  ]
}
```

## 6. 订阅源频道

### 获取订阅源详情

- 方法：`GET /api/feeds/:feedId`
- 认证：`Bearer <token>`
- 查询参数：
  - `feedType`（可选，默认 `FEED`。`FEED`：普通订阅源；`MIX_FEED`：混合源）
- 响应体：

```json
{
  "id": "string",
  "type": "FEED",
  "title": "string",
  "description": "string",
  "icon": "https://example.com",
  "url": "https://example.com/feed.xml",
  "siteUrl": "https://example.com",
  "lastFetched": "2024-03-01T08:00:00Z",
  "lastUpdated": "2024-03-01T09:45:00Z",
  "latestPublishedAt": "2024-03-01T10:00:00Z",
  "articleCount": 128,
  "subscriberCount": 56,
  "subscribed": true,
  "failureCount": 0,
  "fetchError": null,
  "creatorName": "zhangsan",
  "isOwner": false,
  "isPublic": true,
  "filterConfig": null
}
```

- `id`：订阅源的唯一标识（UUID）。
- `type`：源类型，`FEED` 或 `MIX_FEED`。
- `icon`：源图标（统一字段，原 `avatar`）。
- `latestPublishedAt`：最近一篇文章的发布时间，若暂无文章时退回 `lastUpdated`。
- `subscribed`：当前用户是否已订阅该源。
- **Feed 特有字段**：`url`, `siteUrl`, `lastFetched`, `failureCount`, `fetchError`。
- **MixFeed 特有字段**：`creatorName`, `isOwner`, `isPublic`, `filterConfig`。

### 搜索订阅

- 方法：`GET /api/feeds/search`
- 认证：`Bearer <token>`
- 查询参数：
    - `query`（必填，关键词、URL 或 MixFeed 名称）
    - `type`（可选，默认 `ALL`。`ALL`: 所有；`FEED`: 仅 Feed；`MIX_FEED`: 仅 MixFeed）
- 响应体：

```json
[
  {
    "id": "string",
    "type": "FEED",
    "title": "string",
    "description": "string",
    "icon": "https://example.com",
    "subscriberCount": 100,
    "subscribed": false
  }
]
```

- 说明：按 `query` 匹配数据库中现有订阅的 `siteUrl`、`url`、`title` 字段，最多返回 20 条，结构与“获取订阅列表”一致。
- `subscriberCount`：当前平台订阅该源的用户数。
- `subscribed`：当前用户是否已订阅该源。

### 通过 Feed URL 查询详情

- 方法：`GET /api/feeds/lookup`
- 认证：`Bearer <token>`
- 查询参数：
  - `feedUrl`（必填）：订阅源的 RSS 地址。
- 响应体：同 “获取订阅源详情”。

## 7. 用户行为

### 收藏文章

- 方法：`POST /api/user/collections/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Article collected."
}
```

### 取消收藏

- 方法：`DELETE /api/user/collections/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Article uncollected."
}
```

### 获取收藏列表

- 方法：`GET /api/user/collections`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（可选，如 `collectedAt,desc`）
- 响应体：

```json
{
  "content": [
    {
      "articleId": "string",
      "title": "string",
      "collectedAt": "2024-03-01T09:30:00Z"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 12,
  "totalPages": 2,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 记录阅读历史

- 方法：`POST /api/user/history`
- 认证：`Bearer <token>`
- 请求体：

```json
{
  "articleId": "string",
  "readAt": "2024-03-01T10:20:00Z"
}
```

- 说明：`readAt` 可选，未提供时由服务器记录当前时间。
- 响应体：

```json
{
  "message": "History recorded."
}
```

### 获取阅读历史列表

- 方法：`GET /api/user/history`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（默认 `readAt,desc`）
- 响应体：

```json
{
  "content": [
    {
      "articleId": "string",
      "title": "string",
      "readAt": "2024-03-01T10:20:00Z"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 58,
  "totalPages": 6,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 记录 feed 已读

- 方法：`POST /api/user/readfeed/:feedId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Feed read."
}
```

## 8. 搜索

### 搜索文章

- 方法：`GET /api/search`
- 认证：`Bearer <token>`
- 查询参数：
  - `query`（关键词或自然语言，必填）
  - `type`（`keyword` 或 `semantic`，可选，默认 `keyword`）
  - `source`（可选，默认 `owner`。`owner`：只返回当前用户的数据；`global`：返回全局数据，不区分用户）
  - `page`（默认 0）
  - `size`（默认 10）
- 响应体：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "summary": "string",
      "thumbnail": "string",
      "feedTitle": "string",
      "timeAgo": "2 小时前",
      "score": 0.87
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": false,
      "unsorted": true,
      "empty": true
    }
  },
  "totalElements": 23,
  "totalPages": 3,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": false,
    "unsorted": true,
    "empty": true
  },
  "numberOfElements": 10,
  "empty": false
}
```

## 9. 推荐

### AI 实时推荐（SSE 流）

- 方法：`GET /api/ai/recommendations`
- 认证：`Bearer <token>`
- 描述：基于用户历史与偏好生成的实时推荐流。后端使用 Server-Sent Events (SSE) 将推荐项按序推送给客户端，适用于首页或推荐页的增量更新展示。
- 查询参数：
  - `scope`（可选，枚举，默认 `PERSONAL`） — 推荐范围；示例值：`PERSONAL`（个性化）、`RECENT`（24 小时）。
- 返回类型：SSE 文本流（Content-Type: text/event-stream）。每个事件的 `data:` 字段包含一个字符串。

示例：使用 curl 订阅 SSE 流（保持连接以接收连续推荐）：

```bash
curl -H "Authorization: Bearer <token>" -H "Accept: text/event-stream" "https://your-host/api/ai/recommendations?scope=PERSONAL"
```
