# AI 优先 RSS 阅读器：接口文档 (API 文档)

本接口文档描述了前端与后端交互所使用的 RESTful API。

> **分页说明**
> 所有带有 `page` / `size` 查询参数的接口均返回 Spring Data `Page` 风格的响应，示例结构如下（页码从 0 开始）：
>
> ```json
> {
>   "content": [ ... ],
>   "pageable": {
>     "pageNumber": 0,
>     "pageSize": 10,
>     "sort": {
>       "sorted": false,
>       "unsorted": true,
>       "empty": true
>     }
>   },
>   "totalElements": 42,
>   "totalPages": 5,
>   "last": false,
>   "first": true,
>   "size": 10,
>   "number": 0,
>   "sort": {
>     "sorted": false,
>     "unsorted": true,
>     "empty": true
>   },
>   "numberOfElements": 10,
>   "empty": false
> }
> ```

## 1. 用户认证

### 注册

- 方法：`POST /api/auth/register`
- 认证：无需认证
- 请求体：

```json
{
  "username": "string",
  "password": "string"
}
```

- 响应体：

```json
{
  "token": "string",
  "userId": "string"
}
```

### 登录

- 方法：`POST /api/auth/login`
- 认证：无需认证
- 请求体：

```json
{
  "username": "string",
  "password": "string"
}
```

- 响应体：

```json
{
  "token": "string",
  "userId": "string"
}
```

### 获取用户信息

- 方法：`GET /api/user`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "userId": "string",
  "username": "string"
}
```

## 2. 订阅管理

### 添加订阅

- 方法：`POST /api/subscriptions`
- 认证：`Bearer <token>`
- 请求体：

```json
{
  "feedUrl": "string"
}
```

- 响应体：

```json
{
  "message": "Subscription added."
}
```

### 获取订阅列表

- 方法：`GET /api/subscriptions`
- 认证：`Bearer <token>`
- 响应体：

```json
[
  {
    "feedId": "string",
    "title": "string",
    "url": "string",
    "siteUrl": "string",
    "avatar": "https://example.com",
    "lastFetched": "2024-03-01T08:00:00Z",
    "lastUpdated": "2024-03-01T09:45:00Z",
    "isRead": true,
    "failureCount": 0,
    "fetchError": null
  }
]
```

- `lastFetched`：后端最近一次抓取该源的时间。
- `siteUrl`：订阅源对应的网站主页，当缺失时回退至 `url`。
- `lastUpdated`：RSS 源内容检测到的最近更新时间，用于前端提示源的活跃度。
- `isRead`：当前用户已读。
- `failureCount`：连续抓取失败次数，成功抓取后会归零。
- `fetchError`：最近一次抓取失败的错误提示，若暂无失败则为 `null`。

### 取消订阅

- 方法：`DELETE /api/subscriptions/:feedId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Subscription removed."
}
```

### 上传并解析 OPML

- 方法：`POST /api/subscriptions/opml/preview`
- 认证：`Bearer <token>`
- 描述：上传 OPML 文件并解析出订阅源列表，返回结果供用户确认。
- 请求体：`multipart/form-data`
  - `file`：OPML 文件，建议 `Content-Type` 为 `text/x-opml` 或 `application/xml`
- 响应体：

```json
{
  "feeds": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "title": "string",
      "siteUrl": "https://example.com",
      "avatar": "https://example.com/icon.png",
      "alreadySubscribed": false,
      "errors": []
    }
  ],
  "warnings": ["string"],
  "remainingQuota": 480
}
```

- `remainingQuota`：可用订阅额度。每个账号默认上限 500 个订阅，该字段为 `500 - 已订阅数量`。

- 响应码：
  - `200 OK`
  - `400 Bad Request`（文件缺失、格式不合法或无有效订阅）
  - `413 Payload Too Large`
  - `415 Unsupported Media Type`

### 确认 OPML 导入

- 方法：`POST /api/subscriptions/opml/confirm`
- 认证：`Bearer <token>`
- 描述：接收预览结果中的订阅源列表并执行导入，仅导入 `selected = true` 的条目。
- 请求体：

```json
{
  "feeds": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "title": "string",
      "siteUrl": "https://example.com",
      "avatar": "https://example.com/icon.png",
      "selected": true
    }
  ]
}
```

- 响应体：

```json
{
  "importedCount": 3,
  "skipped": [
    {
      "feedUrl": "https://example.com/rss.xml",
      "reason": "ALREADY_SUBSCRIBED"
    }
  ],
  "message": "OPML import completed."
}
```

- 响应码：
  - `200 OK`
  - `400 Bad Request`（请求体为空或结构不符）
  - `409 Conflict`（部分条目导入失败，详情见 `skipped`）
  - `422 Unprocessable Entity`（字段缺失或内容非法）

## 3. 文章内容

### 获取文章列表

- 方法：`GET /api/articles`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（可选，如 `publishedAt,desc`）
  - `feedId`（可选，用于筛选单个订阅源）
  - `tags`（可选，按标签过滤，多个用逗号分隔）
  - `category`（可选，按文章分类过滤，大小写不敏感）
  - `source`（可选，默认 `owner`。`owner`：只返回当前用户的数据；`global`：返回全局数据，不区分用户）
- 响应体：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "link": "string",
      "summary": "string",
      "thumbnail": "https://example.com/cover.jpg",
      "enclosure": "https://example.com/audio.mp3",
      "feedTitle": "string",
      "publishedAt": "2024-03-01T10:00:00Z",
      "tags": ["AI", "推荐"],
      "timeAgo": "2 小时前"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 42,
  "totalPages": 5,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

- `thumbnail`：用于展示文章缩略图，通常来自 RSS 中的图片资源，可能为空。
- `enclosure`：原始多媒体资源链接（音频、视频等），可用于播放器或下载。
- `tags` 查询支持逗号分隔的多个标签，忽略大小写。
- `category` 查询按文章 `category` 字段精确匹配（忽略大小写）。

### 获取文章详情

- 方法：`GET /api/articles/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "id": "string",
  "title": "string",
  "content": "string",
  "summary": "string",
  "thumbnail": "https://example.com/cover.jpg",
  "enclosure": "https://example.com/audio.mp3",
  "feedId": "string",
  "feedTitle": "string",
  "publishedAt": "2024-03-01T10:00:00Z",
  "tags": ["AI", "推荐"]
}
```

### 获取推荐文章

- 方法：`GET /api/articles/recommendations`
- 认证：`Bearer <token>`
- 查询参数：
  - `size`（可选，默认 10，最大 30）
  - `page`（默认 0）
- 响应体示例：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "link": "string",
      "summary": "string",
      "thumbnail": "https://example.com/cover.jpg",
      "enclosure": "https://example.com/audio.mp3",
      "feedTitle": "string",
      "publishedAt": "2024-03-01T10:00:00Z",
      "tags": ["AI", "推荐"],
      "timeAgo": "2 小时前"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 42,
  "totalPages": 5,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 获取订阅内容概览（分类与热门标签）

- 方法：`GET /api/articles/insights`
- 认证：`Bearer <token>`
- 查询参数：
  - `from`（可选，ISO-8601 时间，默认 `now-30d`）
  - `to`（可选，ISO-8601 时间，默认 `now`）
  - `top`（可选，热门标签返回个数，默认 20）
- 说明：统计当前用户可见范围内（其激活的订阅源）的文章，在给定时间窗口内的分类计数和热门标签。
- 响应体：

```json
{
  "categories": [
    {
      "category": "Tech",
      "count": 12
    },
    {
      "category": "AI",
      "count": 8
    }
  ],
  "hotTags": [
    {
      "tag": "llm",
      "count": 10
    },
    {
      "tag": "java",
      "count": 7
    }
  ]
}
```

## 4. 订阅源频道

### 获取订阅源详情

- 方法：`GET /api/feeds/:feedId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "feedId": "string",
  "title": "string",
  "url": "https://example.com/feed.xml",
  "siteUrl": "https://example.com",
  "avatar": "https://example.com",
  "lastFetched": "2024-03-01T08:00:00Z",
  "lastUpdated": "2024-03-01T09:45:00Z",
  "latestPublishedAt": "2024-03-01T10:00:00Z",
  "articleCount": 128,
  "subscriberCount": 56,
  "subscribed": true,
  "failureCount": 0,
  "fetchError": null
}
```

- `latestPublishedAt`：最近一篇文章的发布时间，若暂无文章时退回 `lastUpdated`。
- `subscribed`：当前用户是否已订阅该源。
- `failureCount`：连续抓取失败次数，成功抓取后会归零。
- `fetchError`：最近一次抓取失败的错误提示，若暂无失败则为 `null`。

### 通过 Feed URL 查询详情

- 方法：`GET /api/feeds/lookup`
- 认证：`Bearer <token>`
- 查询参数：
  - `feedUrl`（必填）：订阅源的 RSS 地址。
- 响应体：同 “获取订阅源详情”。

## 4. 用户行为

### 收藏文章

- 方法：`POST /api/user/collections/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Article collected."
}
```

### 取消收藏

- 方法：`DELETE /api/user/collections/:articleId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Article uncollected."
}
```

### 获取收藏列表

- 方法：`GET /api/user/collections`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（可选，如 `collectedAt,desc`）
- 响应体：

```json
{
  "content": [
    {
      "articleId": "string",
      "title": "string",
      "collectedAt": "2024-03-01T09:30:00Z"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 12,
  "totalPages": 2,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 记录阅读历史

- 方法：`POST /api/user/history`
- 认证：`Bearer <token>`
- 请求体：

```json
{
  "articleId": "string",
  "readAt": "2024-03-01T10:20:00Z"
}
```

- 说明：`readAt` 可选，未提供时由服务器记录当前时间。
- 响应体：

```json
{
  "message": "History recorded."
}
```

### 获取阅读历史列表

- 方法：`GET /api/user/history`
- 认证：`Bearer <token>`
- 查询参数：
  - `page`（默认 0）
  - `size`（默认 10）
  - `sort`（默认 `readAt,desc`）
- 响应体：

```json
{
  "content": [
    {
      "articleId": "string",
      "title": "string",
      "readAt": "2024-03-01T10:20:00Z"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    }
  },
  "totalElements": 58,
  "totalPages": 6,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": true,
    "unsorted": false,
    "empty": false
  },
  "numberOfElements": 10,
  "empty": false
}
```

### 记录 feed 已读

- 方法：`POST /api/user/readfeed/:feedId`
- 认证：`Bearer <token>`
- 响应体：

```json
{
  "message": "Feed read."
}
```

## 5. 搜索

### 搜索文章

- 方法：`GET /api/search`
- 认证：`Bearer <token>`
- 查询参数：
  - `query`（关键词或自然语言，必填）
  - `type`（`keyword` 或 `semantic`，可选，默认 `keyword`）
  - `source`（可选，默认 `owner`。`owner`：只返回当前用户的数据；`global`：返回全局数据，不区分用户）
  - `page`（默认 0）
  - `size`（默认 10）
- 响应体：

```json
{
  "content": [
    {
      "id": "string",
      "title": "string",
      "summary": "string",
      "thumbnail": "string",
      "feedTitle": "string",
      "timeAgo": "2 小时前",
      "score": 0.87
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10,
    "sort": {
      "sorted": false,
      "unsorted": true,
      "empty": true
    }
  },
  "totalElements": 23,
  "totalPages": 3,
  "last": false,
  "first": true,
  "size": 10,
  "number": 0,
  "sort": {
    "sorted": false,
    "unsorted": true,
    "empty": true
  },
  "numberOfElements": 10,
  "empty": false
}
```

## 6.推荐

### AI 实时推荐（SSE 流）

- 方法：`GET /api/ai/recommendations`
- 认证：`Bearer <token>`
- 描述：基于用户历史与偏好生成的实时推荐流。后端使用 Server-Sent Events (SSE) 将推荐项按序推送给客户端，适用于首页或推荐页的增量更新展示。
- 查询参数：
  - `scope`（可选，枚举，默认 `PERSONAL`） — 推荐范围；示例值：`PERSONAL`（个性化）、`RECENT`（24 小时）。
- 返回类型：SSE 文本流（Content-Type: text/event-stream）。每个事件的 `data:` 字段包含一个字符串。

示例：使用 curl 订阅 SSE 流（保持连接以接收连续推荐）：

```bash
curl -H "Authorization: Bearer <token>" -H "Accept: text/event-stream" "https://your-host/api/ai/recommendations?scope=PERSONAL"
```
