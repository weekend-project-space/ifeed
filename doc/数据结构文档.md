# 项目数据库表结构

本文件详细定义了 AI 优先 RSS 阅读器项目所使用的数据库架构。

## 1. PostgreSQL (关系型数据库)

该部分用于存储项目的核心结构化数据，确保数据一致性与完整性。

### users 表

| 字段            | 数据类型         | 约束               | 描述      |
|---------------|--------------|------------------|---------|
| id            | UUID         | PRIMARY KEY      | 用户唯一 ID |
| username      | VARCHAR(50)  | NOT NULL, UNIQUE | 用户名     |
| password_hash | VARCHAR(255) | NOT NULL         | 加密后的密码  |
| created_at    | TIMESTAMP    | NOT NULL         | 创建时间    |

### feeds 表

| 字段           | 数据类型         | 约束               | 描述         |
|--------------|--------------|------------------|------------|
| id           | UUID         | PRIMARY KEY      | RSS 源唯一 ID |
| url          | VARCHAR(255) | UNIQUE, NOT NULL | RSS 源 URL  |
| site_url     | VARCHAR(255) | NOT NULL         | 站点主页 URL   |
| title        | VARCHAR(255) |                  | 源标题        |
| last_fetched | TIMESTAMP    |                  | 上次抓取时间     |
| last_updated | TIMESTAMP    |                  | 最近更新时间     |

### user_subscriptions 表

| 字段            | 数据类型      | 约束                                            | 描述           |
|---------------|-----------|-----------------------------------------------|--------------|
| user_id       | UUID      | PRIMARY KEY, FOREIGN KEY REFERENCES users(id) | 关联的用户 ID     |
| feed_id       | UUID      | PRIMARY KEY, FOREIGN KEY REFERENCES feeds(id) | 关联的 RSS 源 ID |
| subscribed_at | TIMESTAMP | NOT NULL                                      | 订阅时间         |
| is_active     | BOOLEAN   | NOT NULL                                      | 订阅是否活跃       |

### articles 表

| 字段          | 数据类型         | 约束                                         | 描述                                               |
|-------------|--------------|--------------------------------------------|--------------------------------------------------|
| id          | UUID         | PRIMARY KEY                                | 文章唯一 ID                                          |
| feed_id     | UUID         | NOT NULL, FOREIGN KEY REFERENCES feeds(id) | 对应的 RSS 源 ID                                     |
| title       | TEXT         | NOT NULL                                   | 文章标题                                             |
| link        | TEXT         | NOT NULL                                   | 原始链接                                             |
| author      | VARCHAR(255) |                                            | 文章作者                                             |
| description | TEXT         |                                            | 文章摘要或描述                                          |
| pub_date    | TIMESTAMP    | NOT NULL                                   | 发布时间                                             |
| thumbnail   | TEXT         |                                            | 缩略图链接                                            |
| enclosure   | TEXT         |                                            | 媒体附件链接（音频、视频等）                                   |
| content     | TEXT         | NOT NULL                                   | 清洗后的纯文本md内容                                      |
| summary     | TEXT         | AI Generated                               | AI 摘要                                            |
| category    | VARCHAR(50)  | AI Generated                               | AI 分类                                            |
| tags        | JSONB        | AI Generated                               | AI 提取的标签（数组）                                     |
| embedding   | TEXT         | AI Generated                               | AI 生成的向量 JSON 表示，便于调试 (废弃 使用 article_embeddings) |

### article_embeddings 表

| 字段        | 数据类型        | 约束                                                  | 描述                        |
|-----------|-------------|-----------------------------------------------------|---------------------------|
| id        | UUID        | PRIMARY KEY, DEFAULT uuid_generate_v4() PRIMARY KEY | ID                        |
| embedding | VECTOR(512) | NOT NULL                                            | 存储向量化表示，供 pg-vector 相似度查询 |
| content   | text        | NOT NULL                                            | text                      |
| metadata  | json        | NOT NULL                                            | 元数据                       |

- 该表 https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html 管理。
- 写入 embedding 时使用 `pgvector` JDBC 扩展，向量维度不匹配将被忽略。

### article_daily_metrics 表

| 字段                | 数据类型      | 约束                                                                                          | 描述         |
|-------------------|-----------|---------------------------------------------------------------------------------------------|------------|
| article_id        | UUID      | PRIMARY KEY(article_id, metric_date), FOREIGN KEY REFERENCES articles(id) ON DELETE CASCADE | 文章 ID      |
| metric_date       | DATE      | PRIMARY KEY(article_id, metric_date)                                                        | 统计日期（UTC）  |
| collected_count   | BIGINT    | NOT NULL                                                                                    | 当日新增收藏数    |
| read_count        | BIGINT    | NOT NULL                                                                                    | 当日新增阅读数    |
| last_collected_at | TIMESTAMP |                                                                                             | 当日最后一次收藏时间 |
| last_read_at      | TIMESTAMP |                                                                                             | 当日最后一次阅读时间 |
| updated_at        | TIMESTAMP | NOT NULL                                                                                    | 记录更新时间     |

- `ArticleMetricAggregationService` 每日汇总 MongoDB `user_behavior` 文档写入此表。
- `ArticleMetricAggregationScheduler` 在 UTC 01:05 触发上一日聚合，重复聚合会先删除同日旧数据再重建。

### article_similarity 表

| 字段                | 数据类型 | 约束                                                                                           | 描述           |
|-------------------|------|------------------------------------------------------------------------------------------------|--------------|
| article_id        | UUID | PRIMARY KEY(article_id, similar_article_id), FOREIGN KEY REFERENCES articles(id) ON DELETE CASCADE | 锚点文章 ID     |
| similar_article_id| UUID | PRIMARY KEY(article_id, similar_article_id), FOREIGN KEY REFERENCES articles(id) ON DELETE CASCADE | 相似文章 ID     |
| similarity        | DOUBLE PRECISION | NOT NULL                                                                                | 协同相似度       |
| updated_at        | TIMESTAMP | NOT NULL                                                                                   | 最后更新时间       |

- `ArticleSimilarityRebuildService` 基于 `article_daily_metrics` 余弦相似度每日重建矩阵，写入该表。
- `ArticleRecommendationRecallService` 优先使用该表提供的 ItemCF 候选，缺失时回退实时计算。

## 2. MongoDB (动态行为数据)

该部分用于存储用户的动态行为数据，文档模型灵活且写入性能高。

### user_behavior 文档结构

```json
{
  "_id": "<user_id>",
  "collections": [
    {
      "article_id": "<article_id>",
      "collected_at": "2023-10-27T10:00:00Z"
    }
  ],
  "read_history": [
    {
      "article_id": "<article_id>",
      "read_at": "2023-10-27T10:00:00Z"
    }
  ],
  "read_feed_history": [
    {
      "feed_id": "<feed_id>",
      "read_at": "2023-10-27T10:00:00Z"
    }
  ],
  "interaction_history": [
    {
      "article_id": "<article_id>",
      "action_type": "skip",
      "timestamp": "2023-10-27T10:05:00Z"
    }
  ]
}
```

- `_id`：用户的唯一 ID。
- `collections`：用户收藏的文章 ID 及收藏时间。
- `read_history`：用户已读文章 ID 及阅读时间。
- `read_feed_history`：用户已读Feed ID 及阅读时间。
- `interaction_history`：用户对文章的其他行为，例如“跳过”、“点赞”等。
