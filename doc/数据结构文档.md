# 项目数据库表结构

本文件详细定义了 AI 优先 RSS 阅读器项目所使用的数据库架构。

双 ID 策略说明（仅 feeds 与 articles）：

- 内部主键：`id INT GENERATED AS IDENTITY PRIMARY KEY`（供外键、排序与索引使用，性能友好）。
- 外部公开：`uid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid()`（对外暴露、跨系统同步）。

初始化扩展（首次部署执行一次）：

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto; -- 用于 gen_random_uuid()
CREATE EXTENSION IF NOT EXISTS vector;   -- pgvector 向量检索
```

## 1. PostgreSQL (关系型数据库)

该部分用于存储项目的核心结构化数据，确保数据一致性与完整性。

### users 表

| 字段          | 数据类型     | 约束                                          | 描述         |
| ------------- | ------------ | --------------------------------------------- | ------------ |
| id            | INT          | GENERATED BY DEFAULT AS IDENTITY, PRIMARY KEY | 用户唯一 ID  |
| username      | VARCHAR(50)  | NOT NULL, UNIQUE                              | 用户名       |
| password_hash | VARCHAR(255) | NOT NULL                                      | 加密后的密码 |
| created_at    | TIMESTAMPTZ  | NOT NULL                                      | 创建时间     |

### feeds 表（双 ID）

| 字段              | 数据类型      | 约束                                          | 描述                         |
| ----------------- | ------------- | --------------------------------------------- | ---------------------------- |
| id                | INT           | GENERATED BY DEFAULT AS IDENTITY, PRIMARY KEY | 内部主键                     |
| uid               | UUID          | UNIQUE, NOT NULL, DEFAULT gen_random_uuid()   | 对外公开 ID                  |
| url               | VARCHAR(255)  | UNIQUE, NOT NULL                              | RSS 源 URL                   |
| site_url          | VARCHAR(255)  | NOT NULL                                      | 站点主页 URL                 |
| title             | VARCHAR(255)  |                                               | 源标题                       |
| last_fetched      | TIMESTAMPTZ   |                                               | 上次抓取时间                 |
| last_updated      | TIMESTAMPTZ   |                                               | 最近更新时间                 |
| last_fetch_status | VARCHAR(32)   | NOT NULL, DEFAULT 'PENDING'                   | 最近一次抓取结果状态         |
| fetch_error_at    | TIMESTAMPTZ   |                                               | 最近抓取失败时间（若有）     |
| fetch_error       | VARCHAR(2048) |                                               | 最近抓取失败的错误信息       |
| failure_count     | INTEGER       | NOT NULL, DEFAULT 0                           | 连续失败次数，成功抓取后重置 |

### user_subscriptions 表

| 字段          | 数据类型    | 约束                                       | 描述                 |
| ------------- | ----------- | ------------------------------------------ | -------------------- |
| user_id       | INT         | NOT NULL, FOREIGN KEY REFERENCES users(id) | 关联的用户 ID        |
| feed_id       | INT         | NOT NULL, FOREIGN KEY REFERENCES feeds(id) | 关联的 RSS 源内部 ID |
| subscribed_at | TIMESTAMPTZ | NOT NULL                                   | 订阅时间             |
| is_active     | BOOLEAN     | NOT NULL                                   | 订阅是否活跃         |

复合主键：`PRIMARY KEY (user_id, feed_id)`。

索引建议：

- `INDEX (user_id, is_active)` — 用户订阅判断/统计。
- `INDEX (feed_id, is_active)` — 订阅数统计。

### articles 表（双 ID）

| 字段                | 数据类型     | 约束                                          | 描述                         |
| ------------------- | ------------ | --------------------------------------------- | ---------------------------- | --- |
| id                  | INT          | GENERATED BY DEFAULT AS IDENTITY, PRIMARY KEY | 内部主键（关系/索引）        |
| uid                 | UUID         | UNIQUE, NOT NULL, DEFAULT gen_random_uuid()   | 对外公开 ID                  |
| feed_id             | INT          | NOT NULL, FOREIGN KEY REFERENCES feeds(id)    | 对应的 RSS 源内部 ID         |
| title               | TEXT         | NOT NULL                                      | 文章标题                     |
| link                | TEXT         | NOT NULL                                      | 原始链接                     |
| author              | VARCHAR(255) |                                               | 文章作者                     |
| description         | TEXT         |                                               | 文章摘要或描述               |
| pub_date            | TIMESTAMPTZ  | NOT NULL                                      | 发布时间                     |
| thumbnail           | TEXT         |                                               | 缩略图链接                   |
| enclosure           | TEXT         |                                               | 媒体附件链接（音频、视频等） |
| content             | TEXT         | NOT NULL                                      | 清洗后的纯文本 md 内容       |
| summary             | TEXT         |                                               | AI 摘要                      |
| category            | VARCHAR(50)  |                                               | AI 分类                      |
| tags                | TEXT         |                                               | AI 提取的标签（JSON 字符串） |
| embedding_generated | boolean      | NOT NULL                                      | 嵌入已生成                   |     |
| ai_generated        | boolean      | NOT NULL                                      | AI 已生成                    |

约束与索引建议：

- 去重唯一约束：`UNIQUE (feed_id, link)`，防止同源重复文章。
- 常用查询索引：`INDEX (feed_id, pub_date DESC)` 用于时间线分页。

### article_embeddings 表

| 字段      | 数据类型     | 约束        | 描述                                                     |
| --------- | ------------ | ----------- | -------------------------------------------------------- |
| id        | TEXT         | PRIMARY KEY | 文档 ID；存储 `articles.uid` 的字符串                    |
| embedding | VECTOR(1024) | NOT NULL    | 存储向量化表示，供 pgvector 相似度查询（维度与配置一致） |
| content   | TEXT         | NOT NULL    | 文本内容                                                 |
| metadata  | JSONB        | NOT NULL    | 元数据（JSONB）                                          |

### user_embeddings 表

| 字段       | 数据类型     | 约束                                          | 描述                                    |
| ---------- | ------------ | --------------------------------------------- | --------------------------------------- |
| user_id    | INT          | PRIMARY KEY, FOREIGN KEY REFERENCES users(id) | 关联的用户 ID                           |
| embedding  | VECTOR(1024) | NOT NULL                                      | 存储向量化表示，供 pg-vector 相似度查询 |
| content    | text         | NOT NULL                                      | text                                    |
| updated_at | TIMESTAMPTZ  | NOT NULL                                      | 更新时间                                |

- 该表 https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html 管理。
- 写入 embedding 时使用 `pgvector` JDBC 扩展，向量维度需与应用配置一致（如 1024）。

说明：向量维度应与应用配置 `app.ai.provider.embedding.options.dimensions` 保持一致。

### user_sessions 表

| 字段       | 数据类型     | 约束                                       | 描述     |
| ---------- | ------------ | ------------------------------------------ | -------- |
| token      | VARCHAR(255) | PRIMARY KEY                                | 会话令牌 |
| user_id    | INT          | NOT NULL, FOREIGN KEY REFERENCES users(id) | 关联用户 |
| created_at | TIMESTAMPTZ  | NOT NULL                                   | 创建时间 |

索引建议：`INDEX (user_id, created_at DESC)`。

## 2. MongoDB (动态行为数据)

该部分用于存储用户的动态行为数据，文档模型灵活且写入性能高。

### user_behavior 文档结构

```json
{
  "_id": "<user_id>",
  "collections": [
    {
      "article_id": "<article_id>",
      "collected_at": "2023-10-27T10:00:00Z"
    }
  ],
  "read_history": [
    {
      "article_id": "<article_id>",
      "read_at": "2023-10-27T10:00:00Z"
    }
  ],
  "read_feed_history": [
    {
      "feed_id": "<feed_id>",
      "read_at": "2023-10-27T10:00:00Z"
    }
  ],
  "interaction_history": [
    {
      "article_id": "<article_id>",
      "action_type": "skip",
      "timestamp": "2023-10-27T10:05:00Z"
    }
  ]
}
```

- `_id`：用户的唯一 ID。
- `collections`：用户收藏的文章 ID 及收藏时间。
- `read_history`：用户已读文章 ID 及阅读时间。
- `read_feed_history`：用户已读 Feed ID 及阅读时间。
- `interaction_history`：用户对文章的其他行为，例如“跳过”、“点赞”等。

注意

- `INT` 上限约 21 亿，文章量极大场景建议 `BIGINT` 用于 articles.id。
- 向量维度需与应用配置一致；若更改维度需重建向量表或重算 embedding。
